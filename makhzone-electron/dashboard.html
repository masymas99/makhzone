<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; connect-src 'self' http://localhost:3001">
  <title>لوحة التحكم</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }
    .sidebar {
      transition: width 0.3s;
    }
    .sidebar.collapsed {
      width: 80px;
    }
    .sidebar.collapsed .sidebar-text {
      display: none;
    }
    .sidebar.collapsed .sidebar-icon {
      margin-right: 0;
    }
    .table-row:nth-child(even) {
      background-color: #f9fafb;
    }
    .table-row:hover {
      background-color: #e5e7eb;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Header -->
  <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
    <div class="flex items-center space-x-4">
      <button id="toggleSidebar" class="text-gray-600 hover:text-blue-600 focus:outline-none">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
        </svg>
      </button>
      <h1 class="text-xl font-semibold">مرحبا، <span id="userName" class="font-bold"></span></h1>
    </div>
    <button id="logout" class="bg-gradient-to-r from-red-500 to-red-600 px-4 py-2 text-white rounded-lg hover:from-red-600 hover:to-red-700 transition-all duration-200">
      تسجيل الخروج
    </button>
  </header>

  <!-- Layout -->
  <div class="flex min-h-[calc(100vh-64px)]">
    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar w-64 bg-white p-6 border-r shadow-lg transition-all duration-300">
      <ul class="space-y-3">
        <li>
          <a href="#" data-page="sales" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-blue-100 hover:text-blue-600 transition-colors duration-200">
            <svg class="sidebar-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="sidebar-text text-lg font-medium">الفواتير</span>
          </a>
        </li>
        <li>
          <a href="#" data-page="products" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-green-100 hover:text-green-600 transition-colors duration-200">
            <svg class="sidebar-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
            </svg>
            <span class="sidebar-text text-lg font-medium">المنتجات</span>
          </a>
        </li>
        <li>
          <a href="#" data-page="traders" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-purple-100 hover:text-purple-600 transition-colors duration-200">
            <svg class="sidebar-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="sidebar-text text-lg font-medium">التجار</span>
          </a>
        </li>
        <li>
          <a href="#" data-page="purchases" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-yellow-100 hover:text-yellow-600 transition-colors duration-200">
            <svg class="sidebar-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
            </svg>
            <span class="sidebar-text text-lg font-medium">المشتريات</span>
          </a>
        </li>
        <li>
          <a href="#" data-page="expenses" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-red-100 hover:text-red-600 transition-colors duration-200">
            <svg class="sidebar-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="sidebar-text text-lg font-medium">المصروفات</span>
          </a>
        </li>
        <li>
          <a href="#" data-page="payments" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-orange-100 hover:text-orange-600 transition-colors duration-200">
            <svg class="sidebar-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
            </svg>
            <span class="sidebar-text text-lg font-medium">الدفعات</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Content -->
    <main id="content" class="flex-1 p-6 overflow-auto">
      <!-- Content will be dynamically loaded here -->
    </main>
  </div>


  <script>
    // Auth guard
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user) window.location.href = 'index.html';
    document.getElementById('userName').innerText = user.name;
    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    });
    // Helper: format date string for display
    function formatDate(dateStr) {
        const d = new Date(dateStr);
        return new Intl.DateTimeFormat('ar-EG', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit'
        }).format(d);
    }
    // Loader functions
    async function loadSales() {
      const res = await fetch('http://localhost:3001/api/sales');
      const data = await res.json();
      let html = '<div class="flex justify-between items-center mb-4">'
        + '<h2 class="text-2xl">قائمة الفواتير</h2>'
        + '<button id="addSaleBtn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">+ إنشاء فاتورة</button>'
      + '</div>';
      if (!res.ok) html += `<p class="text-red-600">${data.error}</p>`;
      else if (data.length === 0) html += '<p>لا توجد فواتير.</p>';
      else {
        html += '<table class="min-w-full bg-white border">';
        html += '<thead><tr><th class="border px-2 py-1">ID</th><th class="border px-2 py-1">التاجر</th><th class="border px-2 py-1">التاريخ</th><th class="border px-2 py-1">الإجمالي</th><th class="border px-2 py-1">الإجراءات</th></tr></thead>';
        html += '<tbody>';
        data.forEach(s => {
          html += `<tr>
            <td class="border px-2 py-1">${s.SaleID}</td>
            <td class="border px-2 py-1">${s.trader?.TraderName || '-'}</td>
            <td class="border px-2 py-1">${formatDate(s.SaleDate)}</td>
            <td class="border px-2 py-1">${s.TotalAmount}</td>
            <td class="border px-2 py-1 space-x-2">
              <button class="view-sale text-blue-600" data-id="${s.SaleID}">عرض</button>
              <button class="edit-sale text-green-600" data-id="${s.SaleID}">تعديل</button>
              <button class="delete-sale text-red-600" data-id="${s.SaleID}">حذف</button>
            </td>
          </tr>`;
        });
        html += '</tbody></table>';
      }
      document.getElementById('content').innerHTML = html;
      document.getElementById('addSaleBtn').addEventListener('click', showAddSaleForm);
      document.querySelectorAll('.view-sale').forEach(btn => btn.addEventListener('click', () => showSaleDetails(btn.dataset.id)));
      document.querySelectorAll('.edit-sale').forEach(btn => btn.addEventListener('click', () => showEditSaleForm(btn.dataset.id)));
      document.querySelectorAll('.delete-sale').forEach(btn => btn.addEventListener('click', () => deleteSale(btn.dataset.id)));
    }
    async function loadProducts() {
      const res = await fetch('http://localhost:3001/api/products');
      const data = await res.json();
      // header with add button
      let html = '<div class="flex justify-between items-center mb-4">'
        + '<h2 class="text-2xl">المنتجات</h2>'
        + '<button id="addProductBtn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">+ إضافة منتج</button>'
      + '</div>';
      html += '<table class="min-w-full bg-white border">';
      html += '<thead><tr><th class="border px-2 py-1">ID</th><th class="border px-2 py-1">الاسم</th><th class="border px-2 py-1">الصنف</th><th class="border px-2 py-1">الكمية</th><th class="border px-2 py-1">سعر البيع</th><th class="border px-2 py-1">سعر التكلفة</th><th class="border px-2 py-1">الإجراءات</th></tr></thead>';
      html += '<tbody>';
      if (res.ok && data.length) {
        data.forEach(p => {
            html += `<tr><td class="border px-2 py-1">${p.ProductID}</td><td class="border px-2 py-1">${p.ProductName}</td><td class="border px-2 py-1">${p.Category}</td><td class="border px-2 py-1">${p.StockQuantity}</td><td class="border px-2 py-1">${p.UnitPrice.toFixed(2)}</td><td class="border px-2 py-1">${p.UnitCost ? p.UnitCost.toFixed(2) : '-'}</td><td class="border px-2 py-1"><button data-id="${p.ProductID}" class="edit-product bg-yellow-400 px-2 py-1 rounded mr-1">تعديل</button><button data-id="${p.ProductID}" class="delete-product bg-red-500 text-white px-2 py-1 rounded">حذف</button></td></tr>`;                   });
      } else html += '<tr><td colspan="6" class="text-center py-2">لا توجد بيانات</td></tr>';
      html += '</tbody></table>';
      document.getElementById('content').innerHTML = html;
      document.querySelectorAll('.edit-product').forEach(btn => btn.addEventListener('click', () => showEditProductForm(btn.dataset.id)));
      document.querySelectorAll('.delete-product').forEach(btn => btn.addEventListener('click', () => deleteProduct(btn.dataset.id)));
      // handle add button
      document.getElementById('addProductBtn').addEventListener('click', showAddProductForm);
    }
    async function loadTraders() {
      const res = await fetch('http://localhost:3001/api/traders');
      const data = await res.json();
      let html = '<div class="flex justify-between items-center mb-4">'
        + '<h2 class="text-2xl">التجار</h2>'
        + '<button id="addTraderBtn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">+ إضافة تاجر</button>'
      + '</div>';
      html += '<table class="min-w-full bg-white border"><thead><tr><th class="border px-2 py-1">ID</th><th class="border px-2 py-1">الاسم</th><th class="border px-2 py-1">الرصيد الحالي</th><th class="border px-2 py-1">الإجراءات</th></tr></thead><tbody>';
      if (res.ok && data.length) {
        await Promise.all(data.map(async t => {
          // Get all sales for this trader
          const salesRes = await fetch(`http://localhost:3001/api/sales?trader=${t.TraderID}`);
          const sales = await salesRes.json();

          // Calculate total paid amount from sales
          const totalPaidAmount = sales.reduce((total, sale) => total + sale.PaidAmount, 0);

          // Get trader payments
          const paymentsRes = await fetch(`http://localhost:3001/api/payments?trader=${t.TraderID}`);
          const payments = await paymentsRes.json();
          const totalPayments = payments.reduce((total, payment) => total + payment.Amount, 0);

          // Calculate balance according to new formula: (payments + sales payments) - total sales
          const balance = (totalPayments + totalPaidAmount) - t.TotalSales;
          const balanceClass = balance < 0 ? 'text-red-600' : 'text-green-600';
          const balanceSign = balance < 0 ? '-' : '+';
          const balanceValue = Math.abs(balance).toFixed(2);

          // Update trader's balance in the database
          try {
            await fetch(`http://localhost:3001/api/traders/${t.TraderID}/balance`, {
              method: 'PUT',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ balance })
            });
          } catch (error) {
            console.error('Error updating trader balance:', error);
          }

          // Update trader's balance in the database
          try {
            await fetch(`http://localhost:3001/api/traders/${t.TraderID}/balance`, {
              method: 'PUT',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ balance })
            });
          } catch (error) {
            console.error('Error updating trader balance:', error);
          }

          html += `<tr>
            <td class="border px-2 py-1">${t.TraderID}</td>
            <td class="border px-2 py-1">${t.TraderName}</td>
            <td class="border px-2 py-1 ${balanceClass}">${balanceSign}${balanceValue}</td>
            <td class="border px-2 py-1">
              <button data-id="${t.TraderID}" class="view-trader bg-blue-500 text-white px-2 py-1 rounded mr-1">عرض</button>
              <button data-id="${t.TraderID}" class="manual-payment bg-blue-500 text-white px-2 py-1 rounded mr-1">إضافة دفعة</button>
              <button data-id="${t.TraderID}" class="edit-trader bg-yellow-400 px-2 py-1 rounded mr-1">تعديل</button>
              <button data-id="${t.TraderID}" class="delete-trader bg-red-500 text-white px-2 py-1 rounded">حذف</button>
            </td>
          </tr>`;
        }));
      } else {
        html += '<tr><td colspan="3" class="text-center py-2">لا توجد بيانات</td></tr>';
      }
      html += '</tbody></table>';
      document.getElementById('content').innerHTML = html;
      document.getElementById('addTraderBtn').addEventListener('click', showAddTraderForm);
      document.querySelectorAll('.view-trader').forEach(btn => btn.addEventListener('click', e => showTraderDetails(e.target.dataset.id)));
      document.querySelectorAll('.manual-payment').forEach(btn => btn.addEventListener('click', e => showManualPaymentForm(e.target.dataset.id)));
      document.querySelectorAll('.edit-trader').forEach(btn => btn.addEventListener('click', e => showEditTraderForm(e.target.dataset.id)));
      document.querySelectorAll('.delete-trader').forEach(btn => btn.addEventListener('click', e => deleteTrader(e.target.dataset.id)));
    }
    async function loadPurchases() {
      const res = await fetch('http://localhost:3001/api/purchases');
      const data = await res.json();
      console.log('Loading purchases data:', data);
      
      let html = `
          <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl">المشتريات</h2>
              <button id="addPurchaseBtn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">+ إنشاء مشتريات</button>
          </div>
          <table class="min-w-full bg-white border">
              <thead>
                  <tr>
                      <th class="border px-2 py-1">ID</th>
                      <th class="border px-2 py-1">التاريخ</th>
                      <th class="border px-2 py-1">المورد</th>
                      <th class="border px-2 py-1">الإجمالي</th>
                      <th class="border px-2 py-1">الإجراءات</th>
                  </tr>
              </thead>
              <tbody id="purchasesTableBody">
              </tbody>
          </table>
      `;
      
      document.getElementById('content').innerHTML = html;
      
      // Add event listener for add button
      const addBtn = document.getElementById('addPurchaseBtn');
      if (addBtn) {
          addBtn.addEventListener('click', async () => {
              console.log('Add purchase button clicked');
              try {
                  const productsRes = await fetch('http://localhost:3001/api/products');
                  const products = await productsRes.json();
                  showAddPurchaseForm(null, products);
              } catch (error) {
                  console.error('Error loading products:', error);
                  alert('خطأ في تحميل المنتجات');
              }
          });
      }

      if (!res.ok) {
          console.error('Error loading purchases:', data.error);
          document.getElementById('purchasesTableBody').innerHTML = 
              `<tr><td colspan="5" class="text-center py-2">${data.error}</td></tr>`;
          return;
      }
      
      if (data.length === 0) {
          document.getElementById('purchasesTableBody').innerHTML = 
              '<tr><td colspan="5" class="text-center py-2">لا توجد مشتريات</td></tr>';
          return;
      }
      
      // Group purchases by PurchaseID
      const groupedPurchases = {};
      data.forEach(p => {
          if (!groupedPurchases[p.PurchaseID]) {
              groupedPurchases[p.PurchaseID] = {
                  PurchaseID: p.PurchaseID,
                  PurchaseDate: p.PurchaseDate,
                  SupplierName: p.SupplierName,
                  TotalAmount: p.TotalAmount,
                  Products: [],
                  Quantities: [],
                  Costs: []
              };
          }
          groupedPurchases[p.PurchaseID].Products.push(
              `${p.ProductName} (${p.Quantity} × ${p.UnitCost})`
          );
      });

      // Add rows to table
      const tbody = document.getElementById('purchasesTableBody');
      Object.values(groupedPurchases).forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
              <td class="border px-2 py-1">${p.PurchaseID}</td>
              <td class="border px-2 py-1">${new Date(p.PurchaseDate).toLocaleDateString()}</td>
              <td class="border px-2 py-1">${p.SupplierName}</td>
              <td class="border px-2 py-1">${p.TotalAmount}</td>
              <td class="border px-2 py-1">
                  <button data-id="${p.PurchaseID}" class="edit-purchase bg-yellow-400 px-2 py-1 rounded mr-1">تعديل</button>
                  <button data-id="${p.PurchaseID}" class="delete-purchase bg-red-500 text-white px-2 py-1 rounded">حذف</button>
              </td>
          `;
          tbody.appendChild(row);
      });

      // Add event listeners for edit buttons
      document.querySelectorAll('.edit-purchase').forEach(btn => {
          btn.addEventListener('click', async () => {
              const id = btn.dataset.id;
              console.log('Edit purchase clicked for ID:', id);
              try {
                  const res = await fetch(`http://localhost:3001/api/purchases/${id}`);
                  const purchase = await res.json();
                  console.log('Loaded purchase data:', purchase);
                  if (res.ok) {
                      showEditPurchaseForm(purchase);
                  } else {
                      console.error('Error loading purchase:', purchase.error);
                      alert('خطأ في تحميل بيانات المشتريات');
                  }
              } catch (error) {
                  console.error('Error in edit button:', error);
                  alert('خطأ في الاتصال بالخادم');
              }
          });
      });

      // Add event listeners for delete buttons
      document.querySelectorAll('.delete-purchase').forEach(btn => {
          btn.addEventListener('click', async () => {
              const id = btn.dataset.id;
              console.log('Delete purchase clicked for ID:', id);
              if (confirm('هل أنت متأكد من حذف هذه المشتريات؟')) {
                  try {
                      const res = await fetch(`http://localhost:3001/api/purchases/${id}`, {
                          method: 'DELETE'
                      });
                      const result = await res.json();
                      console.log('Delete result:', result);
                      if (res.ok) {
                          loadPurchases(); // Reload purchases after deletion
                      } else {
                          console.error('Error deleting purchase:', result.error);
                          alert(result.error || 'خطأ في حذف المشتريات');
                      }
                  } catch (error) {
                      console.error('Error in delete button:', error);
                      alert('خطأ في الاتصال بالخادم');
                  }
              }
          });
      });
    }
    async function loadExpenses() {
      const res = await fetch('http://localhost:3001/api/expenses');
      const data = await res.json();
      let html = '<div class="flex justify-between items-center mb-4">'
        + '<h2 class="text-2xl">المصروفات</h2>'
        + '<button id="addExpenseBtn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">+ إضافة مصروف</button>'
      + '</div>';
      html += '<table class="min-w-full bg-white border"><thead><tr><th class="border px-2 py-1">ID</th><th class="border px-2 py-1">الوصف</th><th class="border px-2 py-1">المبلغ</th><th class="border px-2 py-1">التاريخ</th></tr></thead><tbody>';
      if (res.ok && data.length) {
        data.forEach(e => {
          html += `<tr><td class="border px-2 py-1">${e.ExpenseID}</td><td class="border px-2 py-1">${e.Description}</td><td class="border px-2 py-1">${e.Amount}</td><td class="border px-2 py-1">${e.ExpenseDate}</td></tr>`;
        });
      } else html += '<tr><td colspan="4" class="text-center py-2">لا توجد بيانات</td></tr>';
      html += '</tbody></table>';
      document.getElementById('content').innerHTML = html;
      document.getElementById('addExpenseBtn').addEventListener('click', showAddExpenseForm);
    }
    function showAddExpenseForm() {
      const html = `
        <div class="max-w-md mx-auto bg-white p-6 rounded shadow">
          <h3 class="text-xl mb-4">إضافة مصروف</h3>
          <div id="expenseMsg"></div>
          <form id="expenseForm" class="space-y-4">
            <input type="date" id="expenseDate" class="w-full border px-3 py-2 rounded" required />
            <input type="text" id="expenseDesc" placeholder="الوصف" class="w-full border px-3 py-2 rounded" required />
            <input type="number" step="0.01" id="expenseAmount" placeholder="المبلغ" class="w-full border px-3 py-2 rounded" required />
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded">حفظ</button>
          </form>
        </div>
      `;
      document.getElementById('content').innerHTML = html;

      document.getElementById('expenseForm').addEventListener('submit', async e => {
        e.preventDefault();
        const payload = {
          ExpenseDate: document.getElementById('expenseDate').value,
          Description: document.getElementById('expenseDesc').value,
          Amount: +document.getElementById('expenseAmount').value
        };

        try {
          const res = await fetch('http://localhost:3001/api/expenses', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          });
          const data = await res.json();

          if (res.ok) {
            loadExpenses();
          } else {
            document.getElementById('expenseMsg').innerHTML = `<p class="text-red-600">${data.error}</p>`;
          }
        } catch (error) {
          document.getElementById('expenseMsg').innerHTML = '<p class="text-red-600">خطأ في الاتصال</p>';
        }
      });
    }

    async function loadPayments() {

      const res = await fetch('http://localhost:3001/api/payments');
      const data = await res.json();
      let html = '<h2 class="text-2xl mb-4">الدفعات</h2>';
      html += '<table class="min-w-full bg-white border"><thead><tr><th class="border px-2 py-1">ID</th><th class="border px-2 py-1">ID التاجر</th><th class="border px-2 py-1">اسم التاجر</th><th class="border px-2 py-1">المبلغ</th><th class="border px-2 py-1">التاريخ</th><th class="border px-2 py-1">الإجراءات</th></tr></thead><tbody>';
      if (res.ok && data.length) {
        data.forEach(p => {
          console.log(p);
          html += `<tr><td class="border px-2 py-1">${p.PaymentID}</td><td class="border px-2 py-1">${p.TraderID}</td><td class="border px-2 py-1">${p.TraderName}</td><td class="border px-2 py-1">${p.Amount}</td><td class="border px-2 py-1">${p.PaymentDate}</td><td class="border px-2 py-1">
            <button data-id="${p.PaymentID}" class="edit-payment bg-yellow-400 px-2 py-1 rounded mr-1">تعديل</button>
            <button data-id="${p.PaymentID}" class="delete-payment bg-red-500 text-white px-2 py-1 rounded">حذف</button>
          </td></tr>`;
        });
      } else html += '<tr><td colspan="4" class="text-center py-2">لا توجد بيانات</td></tr>';
      html += '</tbody></table>';
      document.getElementById('content').innerHTML = html;
    }
    // show add product form
    function showAddProductForm() {
      const html = `
        <div class="max-w-md mx-auto bg-white p-6 rounded shadow">
          <h3 class="text-xl mb-4">إضافة منتج</h3>
          <div id="productMsg"></div>
          <form id="productForm" class="space-y-4">
            <input type="text" id="pName" placeholder="الاسم" class="w-full border px-3 py-2 rounded" required />
            <input type="text" id="pCategory" placeholder="الصنف" class="w-full border px-3 py-2 rounded" required />
            <input type="number" id="pStock" placeholder="الكمية" class="w-full border px-3 py-2 rounded" required />
            <input type="number" step="0.01" id="pPrice" placeholder="سعر الوحدة" class="w-full border px-3 py-2 rounded" required />
            <input type="number" step="0.01" id="pCost" placeholder="تكلفة الوحدة" class="w-full border px-3 py-2 rounded" required />
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded">حفظ</button>
          </form>
        </div>
      `;
      document.getElementById('content').innerHTML = html;
      document.getElementById('productForm').addEventListener('submit', async e => {
        e.preventDefault();
        const payload = {
          ProductName: document.getElementById('pName').value,
          Category: document.getElementById('pCategory').value,
          StockQuantity: +document.getElementById('pStock').value,
          UnitPrice: +document.getElementById('pPrice').value,
          UnitCost: +document.getElementById('pCost').value,
          IsActive: true
        };
        try {
          const res = await fetch('http://localhost:3001/api/products', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const data = await res.json();
          if (res.ok) loadProducts(); else document.getElementById('productMsg').innerHTML = `<p class="text-red-600">${data.error}</p>`;
        } catch { document.getElementById('productMsg').innerHTML = '<p class="text-red-600">خطأ في الاتصال</p>'; }
      });
    }
    // show add trader form
    function showAddTraderForm() {
      const html = `
        <div class="max-w-md mx-auto bg-white p-6 rounded shadow">
          <h3 class="text-xl mb-4">إضافة تاجر</h3>
          <div id="traderMsg"></div>
          <form id="traderForm" class="space-y-4">
            <input type="text" id="tName" placeholder="الاسم" class="w-full border px-3 py-2 rounded" required />
            <input type="text" id="tPhone" placeholder="الهاتف" class="w-full border px-3 py-2 rounded" required />
            <input type="text" id="tAddress" placeholder="العنوان" class="w-full border px-3 py-2 rounded" required />
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded">حفظ</button>
          </form>
        </div>
      `;
      document.getElementById('content').innerHTML = html;
      document.getElementById('traderForm').addEventListener('submit', async e => {
        e.preventDefault();
        const payload = {
          TraderName: document.getElementById('tName').value,
          Phone: document.getElementById('tPhone').value,
          Address: document.getElementById('tAddress').value,
          IsActive: true
        };
        try {
          const res = await fetch('http://localhost:3001/api/traders', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const data = await res.json();
          if (res.ok) loadTraders(); else document.getElementById('traderMsg').innerHTML = `<p class="text-red-600">${data.error}</p>`;
        } catch { document.getElementById('traderMsg').innerHTML = '<p class="text-red-600">خطأ في الاتصال</p>'; }
      });
    }
    // edit product
    function showEditProductForm(id) {
      fetch(`http://localhost:3001/api/products/${id}`)
        .then(res => res.json())
        .then(p => {
          const html = `
            <div class="max-w-md mx-auto bg-white p-6 rounded shadow">
              <h3 class="text-xl mb-4">تعديل منتج</h3>
              <div id="productMsg"></div>
              <form id="editProductForm" class="space-y-4">
                <input type="text" id="eName" value="${p.ProductName}" class="w-full border px-3 py-2 rounded" required />
                <input type="text" id="eCategory" value="${p.Category}" class="w-full border px-3 py-2 rounded" required />
                <input type="number" id="eStock" value="${p.StockQuantity}" class="w-full border px-3 py-2 rounded" required />
                <input type="number" step="0.01" id="ePrice" value="${p.UnitPrice}" class="w-full border px-3 py-2 rounded" required />
                <input type="number" step="0.01" id="eCost" value="${p.UnitCost}" class="w-full border px-3 py-2 rounded" required />
                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded">حفظ التعديلات</button>
              </form>
            </div>
          `;
          document.getElementById('content').innerHTML = html;
          document.getElementById('editProductForm').addEventListener('submit', async e => {
            e.preventDefault();
            const payload = {
              ProductName: document.getElementById('eName').value,
              Category: document.getElementById('eCategory').value,
              StockQuantity: +document.getElementById('eStock').value,
              UnitPrice: +document.getElementById('ePrice').value,
              UnitCost: +document.getElementById('eCost').value,
              IsActive: true
            };
            try {
              const res = await fetch(`http://localhost:3001/api/products/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
              const data = await res.json();
              if (res.ok) loadProducts(); else document.getElementById('productMsg').innerHTML = `<p class="text-red-600">${data.error}</p>`;
            } catch { document.getElementById('productMsg').innerHTML = '<p class="text-red-600">خطأ في الاتصال</p>'; }
          });
        });
    }
    // delete product
    function deleteProduct(id) {
      if (!confirm('هل أنت متأكد من حذف المنتج؟')) return;
      fetch(`http://localhost:3001/api/products/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(() => loadProducts());
    }
    // edit trader
    function showEditTraderForm(id) {
      fetch(`http://localhost:3001/api/traders/${id}`)
        .then(res => res.json())
        .then(t => {
          const html = `
            <div class="max-w-md mx-auto bg-white p-6 rounded shadow">
              <h3 class="text-xl mb-4">تعديل تاجر</h3>
              <div id="traderMsg"></div>
              <form id="editTraderForm" class="space-y-4">
                <input type="text" id="eName" value="${t.TraderName}" class="w-full border px-3 py-2 rounded" required />
                <input type="text" id="ePhone" value="${t.Phone}" class="w-full border px-3 py-2 rounded" required />
                <input type="text" id="eAddress" value="${t.Address}" class="w-full border px-3 py-2 rounded" required />
                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded">حفظ التعديلات</button>
              </form>
            </div>
          `;
          document.getElementById('content').innerHTML = html;
          document.getElementById('editTraderForm').addEventListener('submit', async e => {
            e.preventDefault();
            const payload = {
              TraderName: document.getElementById('eName').value,
              Phone: document.getElementById('ePhone').value,
              Address: document.getElementById('eAddress').value,
              IsActive: true
            };
            try {
              const res = await fetch(`http://localhost:3001/api/traders/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
              const data = await res.json();
              if (res.ok) loadTraders(); else document.getElementById('traderMsg').innerHTML = `<p class="text-red-600">${data.error}</p>`;
            } catch { document.getElementById('traderMsg').innerHTML = '<p class="text-red-600">خطأ في الاتصال</p>'; }
          });
        });
    }
    // delete trader
    function deleteTrader(id) {
      if (!confirm('هل أنت متأكد من حذف التاجر؟')) return;
      fetch(`http://localhost:3001/api/traders/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(() => loadTraders());
    }
    // show trader details
    async function showTraderDetails(id) {
      const [traderRes, salesRes] = await Promise.all([
        fetch(`http://localhost:3001/api/traders/${id}`),
        fetch(`http://localhost:3001/api/sales?trader=${id}`)
      ]);
      const trader = await traderRes.json();
      const sales = await salesRes.json();

      // Calculate total paid amount from all invoices
      const totalPaidAmount = sales.reduce((total, sale) => total + sale.PaidAmount, 0);

      // Fetch all payments (sale + manual) for this trader
      const paymentsRes = await fetch(`http://localhost:3001/api/payments/trader/${id}`);
      const payments = await paymentsRes.json();
      const totalPayments = payments.reduce((total, p) => total + p.Amount, 0);

      // Calculate balance using same formula as traders list
      const balance = (totalPayments + totalPaidAmount) - trader.TotalSales;
      const balanceClass = balance < 0 ? 'text-red-600' : 'text-green-600';
      const balanceSign = balance < 0 ? '-' : '+';
      const balanceValue = Math.abs(balance).toFixed(2);

      let html = `<div class="max-w-xl mx-auto bg-white p-6 rounded shadow"><h3 class="text-xl mb-4">تفاصيل التاجر</h3><ul class="list-disc list-inside space-y-1">`;
      html += `<li>ID: ${trader.TraderID}</li>`;
      html += `<li>الاسم: ${trader.TraderName}</li>`;
      html += `<li>الهاتف: ${trader.Phone}</li>`;
      html += `<li>العنوان: ${trader.Address}</li>`;
      html += `<li class="${balanceClass}">الرصيد: ${balanceSign}${balanceValue}</li>`;
      html += `<li>إجمالي المبيعات: ${trader.TotalSales}</li>`;
      html += `<li>إجمالي الدفعات: ${(totalPayments + totalPaidAmount).toFixed(2)}</li>`;
      html += `<li>نشط: ${trader.IsActive ? 'نعم' : 'لا'}</li>`;
      html += `</ul>`;

      // Add manual payment section
      html += `<div class="mt-4 p-4 bg-gray-50 rounded">
        <h4 class="text-lg mb-2">إضافة دفعة يدوية</h4>
        <div id="manualPaymentMsg" class="mb-2"></div>
        <form id="manualPaymentForm" class="space-y-2">
          <input type="hidden" id="manualTraderId" value="${trader.TraderID}">
          <input type="number" id="manualPaymentAmount" placeholder="المبلغ" class="w-full border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required />
          <input type="date" id="manualPaymentDate" class="w-full border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required />
          <textarea id="manualPaymentNote" placeholder="ملاحظات (اختياري)" class="w-full border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
          <button type="submit" class="w-full bg-purple-500 text-white py-2 rounded">إضافة الدفعة</button>
        </form>
      </div>`;

      html += `<button id="backToTraders" class="mt-4 bg-gray-500 text-white px-3 py-1 rounded">رجوع للتجار</button></div>`;
      document.getElementById('content').innerHTML = html;

      // Handle manual payment form submission
      document.getElementById('manualPaymentForm').addEventListener('submit', async e => {
        e.preventDefault();
        const traderId = document.getElementById('manualTraderId').value;
        const amount = document.getElementById('manualPaymentAmount').value;
        const paymentDate = document.getElementById('manualPaymentDate').value;
        const note = document.getElementById('manualPaymentNote').value;

        const res = await fetch('http://localhost:3001/api/manual-payments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            TraderID: traderId,
            Amount: parseFloat(amount),  // Convert to number
            PaymentDate: new Date(paymentDate).toISOString().split('T')[0],  // Format date as YYYY-MM-DD
            Note: note
          })
        });

        const data = await res.json();
        if (res.ok) {
          document.getElementById('manualPaymentMsg').innerHTML = '<p class="text-green-600">تم إضافة الدفعة بنجاح</p>';
          // Reset form
          document.getElementById('manualPaymentForm').reset();
        } else {
          document.getElementById('manualPaymentMsg').innerHTML = `<p class="text-red-600">${data.error || 'خطأ في إضافة الدفعة'}</p>`;
        }
      });

      document.getElementById('backToTraders').addEventListener('click', loadTraders);
    }
    // show create sale form
    async function showAddSaleForm() {
      const [trRes, prodRes] = await Promise.all([fetch('http://localhost:3001/api/traders'), fetch('http://localhost:3001/api/products')]);
      const [traders, products] = await Promise.all([trRes.json(), prodRes.json()]);
      let html = `
        <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
          <h3 class="text-xl mb-4">إنشاء فاتورة</h3>
          <div id="saleMsg"></div>
          <form id="saleForm" class="space-y-4">
            <label>التاجر</label>
            <select id="sTrader" class="w-full border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">اختر تاجر</option>`;
      traders.forEach(t => { html += `<option value="${t.TraderID}">${t.TraderName}</option>`; });
      html += `
            </select>
            <div id="productRows" class="space-y-2">
              <div class="flex items-center space-x-2">
                <select id="sProduct0" class="flex-1 border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="">اختر منتج</option>`;
      products.forEach(p => { html += `<option value="${p.ProductID}" data-price="${p.UnitPrice}" data-cost="${p.UnitCost}" data-stock="${p.StockQuantity}">${p.ProductName} (متوفر: ${p.StockQuantity})</option>`; });
      html += `
                </select>
                <input id="sQuantity0" type="number" min="1" placeholder="الكمية" class="w-1/3 border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                <button id="addProductRow" type="button" class="text-blue-600 font-bold">+</button>
              </div>
            </div>
            <label>المبلغ المدفوع</label>
            <input id="sPaid" type="number" min="0" value="0" class="w-full border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">حفظ</button>
          </form>
        </div>`;
      document.getElementById('content').innerHTML = html;
      let cnt = 1;
      document.getElementById('addProductRow').addEventListener('click', () => {
        const div = document.createElement('div'); div.className = 'flex items-center space-x-2';
        const sel = document.createElement('select'); sel.className='flex-1 border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500'; sel.id=`sProduct${cnt}`;
        sel.innerHTML = '<option value="">اختر منتج</option>';
        products.forEach(p => { sel.innerHTML += `<option value="${p.ProductID}" data-price="${p.UnitPrice}" data-cost="${p.UnitCost}" data-stock="${p.StockQuantity}">${p.ProductName} (متوفر: ${p.StockQuantity})</option>`; });
        const inp = document.createElement('input'); inp.type='number'; inp.min=1; inp.placeholder='الكمية'; inp.id=`sQuantity${cnt}`; inp.className='w-1/3 border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500';
        const rm = document.createElement('button'); rm.type='button'; rm.textContent='حذف'; rm.className='text-red-600'; rm.addEventListener('click', () => div.remove());
        div.append(sel, inp, rm); document.getElementById('productRows').append(div); cnt++;
      });
      document.getElementById('saleForm').addEventListener('submit', async e => {
        e.preventDefault();
        const TraderID = +document.getElementById('sTrader').value;
        const PaidAmount = +document.getElementById('sPaid').value || 0;
        const prods = [];
        for (let i = 0; i < cnt; i++) {
          const ps = document.getElementById(`sProduct${i}`);
          const qs = document.getElementById(`sQuantity${i}`);
          if (ps && ps.value) {
            const stock = +ps.selectedOptions[0].dataset.stock;
            if (+qs.value > stock) {
              document.getElementById('saleMsg').innerHTML = `<p class="text-red-600">الكمية المطلوبة (${+qs.value}) تجاوزت المتوفر (${stock})</p>`;
              return;
            }
            prods.push({ ProductID:+ps.value, Quantity:+qs.value, UnitPrice:+ps.selectedOptions[0].dataset.price, UnitCost:+ps.selectedOptions[0].dataset.cost });
          }
        }
        if (!TraderID || prods.length === 0) {
          document.getElementById('saleMsg').innerHTML = '<p class="text-red-600">اكمل الحقول</p>';
          return;
        }
        try {
          const res = await fetch('http://localhost:3001/api/sales', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ TraderID, PaidAmount, products: prods }) });
          const data = await res.json();
          if (res.ok) loadSales(); else document.getElementById('saleMsg').innerHTML = `<p class="text-red-600">${data.error}</p>`;
        } catch {
          document.getElementById('saleMsg').innerHTML = '<p class="text-red-600">خطأ في الاتصال</p>';
        }
      });
    }
    // Show sale details
    async function showSaleDetails(id) {
      try {
        const res = await fetch(`http://localhost:3001/api/sales/${id}`);
        const s = await res.json();
        if (!res.ok) throw new Error(s.error);
        let html = `<div class="max-w-xl mx-auto bg-white p-6 rounded shadow"><h3 class="text-xl mb-4">تفاصيل الفاتورة #${s.SaleID}</h3>`;
        html += `<ul class="list-disc list-inside space-y-1"><li>التاجر: ${s.trader?.TraderName || '-'}</li><li>تاريخ: ${formatDate(s.SaleDate)}</li><li>الإجمالي: ${s.TotalAmount}</li><li>المدفوع: ${s.PaidAmount}</li><li>المتبقي: ${s.RemainingAmount}</li></ul>`;
        html += `<h4 class="mt-4 mb-2 font-semibold">المنتجات</h4><table class="min-w-full bg-white border"><thead><tr><th class="border px-2 py-1">المنتج</th><th class="border px-2 py-1">سعر الوحدة</th><th class="border px-2 py-1">الكمية</th><th class="border px-2 py-1">المجموع</th></tr></thead><tbody>`;
        s.details.forEach(d => {
          html += `<tr><td class="border px-2 py-1">${d.ProductName}</td><td class="border px-2 py-1">${d.UnitPrice}</td><td class="border px-2 py-1">${d.Quantity}</td><td class="border px-2 py-1">${d.SubTotal}</td></tr>`;
        });
        html += '</tbody></table>';
        html += '<button id="backToSales" class="mt-4 bg-gray-500 text-white px-3 py-1 rounded">رجوع للفواتير</button></div>';
        document.getElementById('content').innerHTML = html;
        document.getElementById('backToSales').addEventListener('click', loadSales);
      } catch (e) {
        document.getElementById('content').innerHTML = `<p class="text-red-600">${e.message}</p>`;
      }
    }
    // Delete sale
    async function deleteSale(id) {
      if (!confirm('هل أنت متأكد من حذف الفاتورة؟')) return;
      const res = await fetch(`http://localhost:3001/api/sales/${id}`, { method: 'DELETE' });
      if (res.ok) loadSales(); else {
        const err = await res.json();
        alert(err.error || 'فشل الحذف');
      }
    }
    // Show edit sale form
    async function showEditSaleForm(id) {
      const [sRes, trRes, prodRes] = await Promise.all([fetch(`http://localhost:3001/api/sales/${id}`), fetch('http://localhost:3001/api/traders'), fetch('http://localhost:3001/api/products')]);
      const s = await sRes.json(), traders = await trRes.json(), products = await prodRes.json();
      let html = `<div class="max-w-2xl mx-auto bg-white p-6 rounded shadow"><h3 class="text-xl mb-4">تعديل الفاتورة #${s.SaleID}</h3>`;
      html += `<div id="saleMsg"></div><form id="editSaleForm" class="space-y-4">`;
      html += '<label>التاجر</label><select id="sTrader" class="w-full border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"><option value="">اختر تاجر</option>';
      traders.forEach(t => { html += `<option value="${t.TraderID}"${t.TraderID===s.TraderID?' selected':''}>${t.TraderName}</option>`; });
      html += '</select><div id="productRows" class="space-y-2">';
      let cnt = 0;
      s.details.forEach(d => {
        html += `<div class="flex items-center space-x-2"><select id="sProduct${cnt}" class="flex-1 border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"><option value="">اختر منتج</option>`;
        products.forEach(p => { html += `<option value="${p.ProductID}" data-price="${p.UnitPrice}" data-cost="${p.UnitCost}" data-stock="${p.StockQuantity}"${p.ProductID===d.ProductID?' selected':''}>${p.ProductName} (متوفر: ${p.StockQuantity})</option>`; });
        html += `</select><input id="sQuantity${cnt}" type="number" min="1" value="${d.Quantity}" class="w-1/3 border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" /><button type="button" class="remove-row text-red-600">حذف</button></div>`;
        cnt++;
      });
      html += '</div><button id="addProductRow" type="button" class="text-blue-600 font-bold">+</button>';
      html += '<label>المبلغ المدفوع</label>';
      html += `<input id="sPaid" type="number" min="0" value="${s.PaidAmount}" class="w-full border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />`;
      html += '<button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">حفظ التعديلات</button></form></div>';
      document.getElementById('content').innerHTML = html;
      document.getElementById('addProductRow').addEventListener('click', () => {
        const div = document.createElement('div'); div.className = 'flex items-center space-x-2';
        const sel = document.createElement('select'); sel.className='flex-1 border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500'; sel.id=`sProduct${cnt}`;
        sel.innerHTML = '<option value="">اختر منتج</option>';
        products.forEach(p => { sel.innerHTML += `<option value="${p.ProductID}" data-price="${p.UnitPrice}" data-cost="${p.UnitCost}" data-stock="${p.StockQuantity}">${p.ProductName} (متوفر: ${p.StockQuantity})</option>`; });
        const inp = document.createElement('input'); inp.type='number'; inp.min=1; inp.placeholder='الكمية'; inp.id=`sQuantity${cnt}`; inp.className='w-1/3 border-gray-300 px-3 py-2 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500';
        const rm = document.createElement('button'); rm.type='button'; rm.textContent='حذف'; rm.className='text-red-600'; rm.addEventListener('click', () => div.remove());
        div.append(sel, inp, rm); document.getElementById('productRows').append(div); cnt++;
      });
      document.querySelectorAll('.remove-row').forEach(b => b.addEventListener('click', e => e.target.parentNode.remove()));
      document.getElementById('editSaleForm').addEventListener('submit', async e => {
        e.preventDefault();
        const TraderID = +document.getElementById('sTrader').value;
        const PaidAmount = +document.getElementById('sPaid').value || 0;
        const prods = [];
        for (let i = 0; i < cnt; i++) {
          const ps = document.getElementById(`sProduct${i}`);
          const qs = document.getElementById(`sQuantity${i}`);
          if (ps && ps.value) {
            const stock = +ps.selectedOptions[0].dataset.stock;
            if (+qs.value > stock) {
              document.getElementById('saleMsg').innerHTML = `<p class="text-red-600">الكمية المطلوبة (${+qs.value}) تجاوزت المتوفر (${stock})</p>`;
              return;
            }
            prods.push({ ProductID:+ps.value, Quantity:+qs.value, UnitPrice:+ps.selectedOptions[0].dataset.price, UnitCost:+ps.selectedOptions[0].dataset.cost });
          }
        }
        if (!TraderID || prods.length===0) {
          document.getElementById('saleMsg').innerHTML='<p class="text-red-600">اكمل الحقول</p>';
          return;
        }
        const res = await fetch(`http://localhost:3001/api/sales/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json' }, body:JSON.stringify({ TraderID, PaidAmount, products:prods }) });
        const d = await res.json();
        if (res.ok) loadSales(); else document.getElementById('saleMsg').innerHTML=`<p class="text-red-600">${d.error}</p>`;
      });
    }
    // Show add purchase form
    async function showAddPurchaseForm() {
      const res = await fetch('http://localhost:3001/api/products');
      const products = await res.json();
      let html = `<div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
        <h3 class="text-xl mb-4">إنشاء مشتريات</h3>
        <div id="purchaseMsg"></div>
        <form id="purchaseForm" class="space-y-4">
          <label>المورد</label>
          <input id="supplierName" type="text" class="w-full border px-3 py-2 rounded" placeholder="اسم المورد" required />
          <label>ملاحظات</label>
          <textarea id="notes" class="w-full border px-3 py-2 rounded" placeholder="ملاحظات (اختياري)"></textarea>
          <div id="purchaseRows" class="space-y-2">
            <div class="grid grid-cols-6 gap-2 items-center border-b pb-2 mb-2">
              <select id="pProduct0" class="col-span-2 border px-3 py-2 rounded">
                <option value="">اختر منتج</option>
                <option value="new">+ منتج جديد</option>
                ${products.map(p => `<option value="${p.ProductID}" data-cost="${p.UnitCost}" data-stock="${p.StockQuantity}">${p.ProductName} (متوفر: ${p.StockQuantity})</option>`).join('')}
              </select>
              <input id="pQuantity0" type="number" min="1" placeholder="الكمية" class="col-span-1 border px-3 py-2 rounded" />
              <input id="pCost0" type="number" step="0.01" placeholder="التكلفة" class="col-span-1 border px-3 py-2 rounded" />
              <button id="addPurchaseRow" type="button" class="col-span-1 text-blue-600 font-bold text-2xl">+</button>
              <div id="pNewFields0" class="col-span-6 grid grid-cols-3 gap-2 mt-2 hidden">
                <input type="text" id="pNewName0" name="pNewName0" placeholder="اسم المنتج" class="border px-3 py-2 rounded flex-1" />
                <input type="text" id="pNewCategory0" name="pNewCategory0" placeholder="الصنف" class="border px-3 py-2 rounded flex-1" />
                <input type="number" step="0.01" id="pNewPrice0" name="pNewPrice0" placeholder="سعر الوحدة" class="border px-3 py-2 rounded flex-1" />
              </div>
            </div>
          </div>
          <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded">حفظ</button>
        </form>
      </div>`;
      document.getElementById('content').innerHTML = html;
      document.getElementById('pProduct0').addEventListener('change', e => {
        document.getElementById('pNewFields0').classList.toggle('hidden', e.target.value !== 'new');
      });
      let cnt = 1;
      document.getElementById('addPurchaseRow').addEventListener('click', () => {
        const div = document.createElement('div');
        div.className = 'grid grid-cols-6 gap-2 items-center border-b pb-2 mb-2';
        const sel = document.createElement('select');
        sel.id = `pProduct${cnt}`;
        sel.className = 'col-span-2 border px-3 py-2 rounded';
        sel.innerHTML = '<option value="">اختر منتج</option><option value="new">+ منتج جديد</option>';
        products.forEach(p => {
          sel.innerHTML += `<option value="${p.ProductID}" data-cost="${p.UnitCost}" data-stock="${p.StockQuantity}">${p.ProductName} (متوفر: ${p.StockQuantity})</option>`;
        });
        const q = document.createElement('input');
        q.id = `pQuantity${cnt}`;
        q.type = 'number';
        q.min = 1;
        q.placeholder = 'الكمية';
        q.className = 'col-span-1 border px-3 py-2 rounded';
        const c = document.createElement('input');
        c.id = `pCost${cnt}`;
        c.type = 'number';
        c.step = '0.01';
        c.placeholder = 'التكلفة';
        c.className = 'col-span-1 border px-3 py-2 rounded';
        const rm = document.createElement('button');
        rm.type = 'button';
        rm.textContent = '×';
        rm.className = 'col-span-1 text-red-600 font-bold';
        rm.addEventListener('click', () => div.remove());
        const newFields = document.createElement('div');
        newFields.id = `pNewFields${cnt}`;
        newFields.className = 'col-span-6 grid grid-cols-3 gap-2 mt-2 hidden';
        const newName = document.createElement('input');
        newName.type = 'text';
        newName.id = `pNewName${cnt}`;
        newName.name = `pNewName${cnt}`;
        newName.placeholder = 'اسم المنتج';
        newName.className = 'border px-3 py-2 rounded flex-1';
        const newCat = document.createElement('input');
        newCat.type = 'text';
        newCat.id = `pNewCategory${cnt}`;
        newCat.name = `pNewCategory${cnt}`;
        newCat.placeholder = 'الصنف';
        newCat.className = 'border px-3 py-2 rounded flex-1';
        const newPrice = document.createElement('input');
        newPrice.type = 'number';
        newPrice.step = '0.01';
        newPrice.id = `pNewPrice${cnt}`;
        newPrice.name = `pNewPrice${cnt}`;
        newPrice.placeholder = 'سعر الوحدة';
        newPrice.className = 'border px-3 py-2 rounded flex-1';
        newFields.append(newName, newCat, newPrice);
        div.append(sel, q, c, rm);
        div.append(newFields);
        document.getElementById('purchaseRows').append(div);
        cnt++;
        sel.addEventListener('change', e => {
          document.getElementById(`pNewFields${cnt-1}`).classList.toggle('hidden', e.target.value !== 'new');
        });
      });
      document.getElementById('purchaseForm').addEventListener('submit', async e => {
        e.preventDefault();
        const supplier_name = document.getElementById('supplierName').value.trim();
        const notes = document.getElementById('notes').value.trim();
        const rows = [];
        for (let i = 0; i < cnt; i++) {
          const ps = document.getElementById(`pProduct${i}`);
          const qs = document.getElementById(`pQuantity${i}`);
          const cs = document.getElementById(`pCost${i}`);
          if (ps && ps.value) {
            if (ps.value === 'new') {
              alert('يجب إضافة المنتج أولاً من قسم المنتجات');
              return;
            } else {
              rows.push({ product_id: +ps.value, quantity: +qs.value, unit_cost: +cs.value });
            }
          }
        }
        if (!supplier_name) {
          document.getElementById('purchaseMsg').innerHTML = '<p class="text-red-600">اسم المورد مطلوب</p>';
          return;
        }
        if (rows.length === 0) {
          document.getElementById('purchaseMsg').innerHTML = '<p class="text-red-600">اختر منتج واحد على الأقل</p>';
          return;
        }
        const res2 = await fetch('http://localhost:3001/api/purchases', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            supplier_name,
            notes,
            products: rows.filter(p => p.product_id && !isNaN(p.product_id))
          })
        });
        const r = await res2.json();
        if (res2.ok) {
          loadPurchases();
        } else {
          const errorMsg = r.details ? r.details.join(', ') : r.error;
          document.getElementById('purchaseMsg').innerHTML = `<p class="text-red-600">${errorMsg || 'خطأ غير معروف'}</p>`;
        }
      });
    }
    // Function to show edit purchase form
    function showEditPurchaseForm(purchase) {
      showAddPurchaseForm();
    }
    // navigation handler
    document.querySelectorAll('nav a').forEach(a => a.addEventListener('click', e => {
      e.preventDefault();
      const page = a.getAttribute('data-page');
      if (page === 'sales') loadSales();
      else if (page === 'products') loadProducts();
      else if (page === 'traders') loadTraders();
      else if (page === 'purchases') loadPurchases();
      else if (page === 'expenses') loadExpenses();
      else if (page === 'payments') loadPayments();
    }));
    // Add active state to current page navigation
    const currentPage = window.location.hash.substring(1) || 'sales'; // Get the current page from URL hash or default to 'sales'
    document.querySelectorAll('nav a').forEach(a => {
      const page = a.getAttribute('data-page');
      if (page === currentPage) {
        a.classList.add('bg-blue-50', 'text-blue-600');
      }
      a.addEventListener('click', e => {
        e.preventDefault();
        const page = a.getAttribute('data-page');
        // Remove active state from all links
        document.querySelectorAll('nav a').forEach(link => {
          link.classList.remove('bg-blue-50', 'text-blue-600');
        });
        // Add active state to clicked link
        a.classList.add('bg-blue-50', 'text-blue-600');
        // Update URL hash
        window.location.hash = page;
        // Load the content
        if (page === 'sales') loadSales();
        else if (page === 'products') loadProducts();
        else if (page === 'traders') loadTraders();
        else if (page === 'purchases') loadPurchases();
        else if (page === 'expenses') loadExpenses();
        else if (page === 'payments') loadPayments();
      });
    });
    // initial load
    loadSales();
  </script>
</body>
</html>
